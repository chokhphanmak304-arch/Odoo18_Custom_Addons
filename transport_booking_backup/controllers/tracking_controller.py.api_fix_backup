# -*- coding: utf-8 -*-
import json
import logging
from datetime import datetime
from odoo import http
from odoo.http import request

_logger = logging.getLogger(__name__)


class TrackingController(http.Controller):
    
    @http.route('/tracking/map/<int:booking_id>', type='http', auth='user', methods=['GET'])
    def tracking_map_view(self, booking_id, **kwargs):
        """
        üó∫Ô∏è ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏ö‡∏ö Real-time
        """
        try:
            booking = request.env['vehicle.booking'].browse(booking_id)
            if not booking.exists():
                return request.render('transport_booking.tracking_map_error', {
                    'error_message': '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ñ'
                })
            
            # ‡∏î‡∏∂‡∏á API Key ‡∏à‡∏≤‡∏Å settings
            IrConfigParam = request.env['ir.config_parameter'].sudo()
            api_key = (
                IrConfigParam.get_param('google_maps_api_key') or
                IrConfigParam.get_param('google.maps_api_key') or
                'AIzaSyAorvWR_BL6tgkNgkkRO4NIb8ZTKq92S3U'
            )
            
            # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö
            driver_name = None
            if booking.driver_id:
                try:
                    # ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á field ‡∏ï‡πà‡∏≤‡∏á‡πÜ
                    if hasattr(booking.driver_id, 'name') and booking.driver_id.name:
                        driver_name = booking.driver_id.name
                    elif hasattr(booking.driver_id, 'display_name') and booking.driver_id.display_name:
                        driver_name = booking.driver_id.display_name
                    else:
                        driver_name = f"‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö ID: {booking.driver_id.id}"
                except:
                    driver_name = None
            
            # Fallback to delivery_employee_name
            if not driver_name and booking.delivery_employee_name:
                driver_name = booking.delivery_employee_name
            
            if not driver_name:
                driver_name = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö'
            
            # ‡∏î‡∏∂‡∏á tracking_interval ‡∏à‡∏≤‡∏Å tracking.settings
            settings_model = request.env['tracking.settings']
            user_settings = settings_model.get_user_settings(request.env.user.id)
            refresh_interval = user_settings.get('tracking_interval', 5)  # default 5 ‡∏ô‡∏≤‡∏ó‡∏µ
            
            _logger.info(f"üó∫Ô∏è [Map] Loading map for booking {booking.name}")
            _logger.info(f"üîë [Map] API Key: {api_key[:20]}...{api_key[-5:] if len(api_key) > 25 else ''}")
            _logger.info(f"üë§ [Map] Driver: {driver_name}")
            _logger.info(f"‚è±Ô∏è  [Map] Refresh Interval: {refresh_interval} minutes")
            
            return request.render('transport_booking.tracking_map_food_delivery_style', {
                'booking': booking,
                'api_key': api_key,
                'driver_name': driver_name,
                'refresh_interval': refresh_interval,  # ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏¢‡∏±‡∏á template
            })
        except Exception as e:
            _logger.error(f"‚ùå Error rendering tracking map: {str(e)}")
            return request.render('transport_booking.tracking_map_error', {
                'error_message': str(e)
            })
    
    @http.route('/api/settings/get', type='json', auth='user', methods=['POST'], csrf=False)
    def get_user_settings(self, **kwargs):
        """
        ‚öôÔ∏è API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        
        Returns:
            - success: Boolean
            - data: User settings object
        """
        try:
            settings_model = request.env['tracking.settings']
            settings = settings_model.get_user_settings(request.env.user.id)
            
            _logger.info(f"‚öôÔ∏è [Settings] User {request.env.user.name} settings loaded")
            
            return {
                'success': True,
                'data': settings
            }
        except Exception as e:
            _logger.error(f"‚ùå Error getting user settings: {str(e)}")
            return {
                'success': False,
                'message': str(e),
                'data': {
                    'tracking_interval': 5,
                    'tracking_enabled': True,
                    'show_route': True,
                    'show_speed': True,
                    'notify_on_arrival': True
                }
            }
    
    @http.route('/api/booking/get_active_job', type='json', auth='user', methods=['POST'], csrf=False)
    def get_active_job(self, driver_id, **kwargs):
        """
        üöö API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        
        Parameters:
            - driver_id: ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö
        
        Returns:
            - success: Boolean
            - data: Booking object ‡∏´‡∏£‡∏∑‡∏≠ null ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥
        """
        try:
            # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ in_progress ‡∏Ç‡∏≠‡∏á driver ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ
            active_booking = request.env['vehicle.booking'].search([
                ('driver_id', '=', int(driver_id)),
                ('state', '=', 'in_progress')
            ], limit=1, order='planned_start_date desc')
            
            if not active_booking:
                return {
                    'success': True,
                    'data': None,
                    'message': '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡∏π‡πà'
                }
            
            # ‚úÖ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° driver_name
            driver_name = None
            if active_booking.driver_id:
                driver_name = active_booking.driver_id.name or f"ID: {active_booking.driver_id.id}"
            
            # ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• booking ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
            return {
                'success': True,
                'data': {
                    'id': active_booking.id,
                    'name': active_booking.name,
                    'state': active_booking.state,
                    'tracking_status': active_booking.tracking_status,
                    'pickup_location': active_booking.pickup_location,
                    'destination': active_booking.destination,
                    'planned_start_date': active_booking.planned_start_date.isoformat() if active_booking.planned_start_date else None,
                    'planned_end_date': active_booking.planned_end_date.isoformat() if active_booking.planned_end_date else None,
                    'partner_name': active_booking.partner_id.name if active_booking.partner_id else None,
                    'vehicle_name': active_booking.vehicle_id.license_plate if active_booking.vehicle_id else None,
                    'distance_km': active_booking.distance_km,
                    'shipping_cost': active_booking.shipping_cost,
                    'driver_id': active_booking.driver_id.id if active_booking.driver_id else None,
                    'driver_name': driver_name,  # ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
                },
                'message': f'‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡∏π‡πà: {active_booking.name}'
            }
        except Exception as e:
            _logger.error(f"‚ùå Error getting active job: {str(e)}")
            return {'success': False, 'message': str(e)}
    
    @http.route('/api/tracking/update_location', type='json', auth='user', methods=['POST'], csrf=False)
    def update_vehicle_location(self, booking_id, latitude, longitude, speed=0, heading=0, 
                                 accuracy=None, altitude=None, battery_level=None, address=None, **kwargs):
        """
        üìç API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏ñ‡πÅ‡∏ö‡∏ö Real-time
        
        Parameters:
            - booking_id: ID ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ñ
            - latitude: ‡∏û‡∏¥‡∏Å‡∏±‡∏î Latitude
            - longitude: ‡∏û‡∏¥‡∏Å‡∏±‡∏î Longitude
            - speed: ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß (km/h)
            - heading: ‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á (‡∏≠‡∏á‡∏®‡∏≤ 0-360)
            - accuracy: ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏≠‡∏á GPS (‡πÄ‡∏°‡∏ï‡∏£)
            - altitude: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ó‡∏∞‡πÄ‡∏• (‡πÄ‡∏°‡∏ï‡∏£)
            - battery_level: ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà (0-100)
            - address: ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        """
        try:
            _logger.info('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ')
            _logger.info('üìç [API] Received location update request')
            _logger.info(f'   üì¶ Booking ID: {booking_id}')
            _logger.info(f'   üåê Coordinates: {latitude}, {longitude}')
            _logger.info(f'   üéØ Accuracy: {accuracy}m' if accuracy else '   üéØ Accuracy: N/A')
            _logger.info(f'   üöó Speed: {speed} km/h')
            _logger.info(f'   üß≠ Heading: {heading}¬∞')
            _logger.info(f'   üîã Battery: {battery_level}%' if battery_level else '   üîã Battery: N/A')
            if address:
                _logger.info(f'   üìÆ Address: {address}')
            
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö booking
            booking = request.env['vehicle.booking'].browse(int(booking_id))
            if not booking.exists():
                _logger.error(f'‚ùå [API] Booking not found: {booking_id}')
                return {'success': False, 'message': f'‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ñ ID: {booking_id}'}
            
            _logger.info(f'   ‚úÖ Booking found: {booking.name}')
            _logger.info(f'   üìä Current state: {booking.state}')
            _logger.info(f'   üöö Vehicle: {booking.vehicle_id.license_plate if booking.vehicle_id else "N/A"}')
            
            # üõë ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô 'done' (‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô) ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
            if booking.state == 'done':
                _logger.warning('üõë [API] Booking is DONE - Stop sending location updates!')
                _logger.info('   üìç Generating final map with complete tracking history...')
                
                # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                tracking_records = request.env['vehicle.tracking'].search([
                    ('booking_id', '=', booking.id)
                ], order='timestamp asc')
                
                final_map_data = {
                    'tracking_count': len(tracking_records),
                    'start_point': {
                        'latitude': booking.pickup_latitude,
                        'longitude': booking.pickup_longitude,
                        'address': booking.pickup_location,
                    },
                    'end_point': {
                        'latitude': booking.destination_latitude,
                        'longitude': booking.destination_longitude,
                        'address': booking.destination,
                    },
                    'route': []
                }
                
                # ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                for track in tracking_records:
                    final_map_data['route'].append({
                        'timestamp': track.timestamp.isoformat() if track.timestamp else '',
                        'latitude': track.latitude,
                        'longitude': track.longitude,
                        'speed': track.speed,
                        'heading': track.heading,
                        'address': track.address or '',
                    })
                
                _logger.info(f'   ‚úÖ Final map prepared with {len(tracking_records)} tracking points')
                
                return {
                    'success': False,  # ‡∏™‡πà‡∏á False ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏∏‡∏î
                    'message': '‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß - ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
                    'booking_state': 'done',
                    'final_map_data': final_map_data,
                    'should_stop_tracking': True,
                }
            
            # üõë ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô 'done' (‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô) ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
            if booking.state == 'done':
                _logger.warning('üõë [API] Booking is DONE - Stop sending location updates!')
                _logger.info('   üìç Generating final map with complete tracking history...')
                
                # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                tracking_records = request.env['vehicle.tracking'].search([
                    ('booking_id', '=', booking.id)
                ], order='timestamp asc')
                
                final_map_data = {
                    'tracking_count': len(tracking_records),
                    'start_point': {
                        'latitude': booking.pickup_latitude,
                        'longitude': booking.pickup_longitude,
                        'address': booking.pickup_location,
                    },
                    'end_point': {
                        'latitude': booking.destination_latitude,
                        'longitude': booking.destination_longitude,
                        'address': booking.destination,
                    },
                    'route': []
                }
                
                # ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                for track in tracking_records:
                    final_map_data['route'].append({
                        'timestamp': track.timestamp.isoformat() if track.timestamp else '',
                        'latitude': track.latitude,
                        'longitude': track.longitude,
                        'speed': track.speed,
                        'heading': track.heading,
                        'address': track.address or '',
                    })
                
                _logger.info(f'   ‚úÖ Final map prepared with {len(tracking_records)} tracking points')
                _logger.info('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ')
                
                return {
                    'success': False,  # ‡∏™‡πà‡∏á False ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏∏‡∏î
                    'message': '‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß - ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
                    'booking_state': 'done',
                    'final_map_data': final_map_data,
                    'should_stop_tracking': True,
                }
            
            # üõë ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô 'done' (‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô) ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
            if booking.state == 'done':
                _logger.warning('üõë [API] Booking is DONE - Stop sending location updates!')
                _logger.info('   üìç Generating final map with complete tracking history...')
                
                # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                tracking_records = request.env['vehicle.tracking'].search([
                    ('booking_id', '=', booking.id)
                ], order='timestamp asc')
                
                final_map_data = {
                    'tracking_count': len(tracking_records),
                    'start_point': {
                        'latitude': booking.pickup_latitude,
                        'longitude': booking.pickup_longitude,
                        'address': booking.pickup_location,
                    },
                    'end_point': {
                        'latitude': booking.destination_latitude,
                        'longitude': booking.destination_longitude,
                        'address': booking.destination,
                    },
                    'route': []
                }
                
                # ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                for track in tracking_records:
                    final_map_data['route'].append({
                        'timestamp': track.timestamp.isoformat() if track.timestamp else '',
                        'latitude': track.latitude,
                        'longitude': track.longitude,
                        'speed': track.speed,
                        'heading': track.heading,
                        'address': track.address or '',
                    })
                
                _logger.info(f'   ‚úÖ Final map prepared with {len(tracking_records)} tracking points')
                _logger.info('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ')
                
                return {
                    'success': False,  # ‡∏™‡πà‡∏á False ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏∏‡∏î
                    'message': '‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß - ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
                    'booking_state': 'done',
                    'final_map_data': final_map_data,
                    'should_stop_tracking': True,
                }
            _logger.info('   üíæ Updating booking current location...')
            update_vals = {
                'current_latitude': float(latitude),
                'current_longitude': float(longitude),
                'gps_last_update': datetime.now(),
            }
            
            # ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó current_location (address) ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡πà‡∏á‡∏°‡∏≤
            if address:
                update_vals['current_location'] = str(address)
                _logger.info(f'   üìÆ Updating current location: {address}')
            
            booking.write(update_vals)
            _logger.info('   ‚úÖ Booking location updated')
            
            # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
            _logger.info('   üíæ Creating tracking history record...')
            tracking_vals = {
                'booking_id': booking.id,
                'driver_id': booking.driver_id.id,  # ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ driver_id ‡πÄ‡∏™‡∏°‡∏≠
                'latitude': float(latitude),
                'longitude': float(longitude),
                'speed': float(speed),
                'heading': float(heading),
                'timestamp': datetime.now(),
            }
            
            # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if accuracy is not None:
                tracking_vals['accuracy'] = float(accuracy)
            if altitude is not None:
                tracking_vals['altitude'] = float(altitude)
            if battery_level is not None:
                tracking_vals['battery_level'] = float(battery_level)
            if address:
                tracking_vals['address'] = str(address)
            
            tracking_record = request.env['vehicle.tracking'].create(tracking_vals)
            _logger.info(f'   ‚úÖ Tracking record created: ID {tracking_record.id}')
            
            # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            off_route = False
            settings = request.env['tracking.settings'].get_or_create_settings(request.env.user.id)
            
            if settings.notify_off_route and booking.waypoints_json:
                _logger.info('   üîç Checking off-route status...')
                off_route = self._check_off_route(
                    float(latitude), 
                    float(longitude), 
                    booking.waypoints_json,
                    settings.off_route_distance
                )
                if off_route:
                    _logger.warning(f'   ‚ö†Ô∏è  Vehicle is OFF ROUTE! Distance > {settings.off_route_distance}m')
                else:
                    _logger.info('   ‚úÖ Vehicle is on route')
            
            _logger.info('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ')
            _logger.info('‚úÖ [API] Location update completed successfully')
            _logger.info(f'   üì¶ Booking: {booking.name}')
            _logger.info(f'   üìä Status: {booking.tracking_status}')
            _logger.info(f'   üö® Off Route: {off_route}')
            _logger.info('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ')
            
            # ‚úÖ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° driver_name
            driver_name = None
            if booking.driver_id:
                driver_name = booking.driver_id.name or f"ID: {booking.driver_id.id}"
            
            return {
                'success': True,
                'message': '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                'data': {
                    'booking_id': booking.id,
                    'booking_name': booking.name,
                    'current_status': booking.tracking_status,
                    'off_route': off_route,
                    'last_update': datetime.now().isoformat(),
                    'driver_id': booking.driver_id.id if booking.driver_id else None,
                    'driver_name': driver_name,  # ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
                }
            }
            
        except Exception as e:
            _logger.error('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ')
            _logger.error(f'‚ùå [API] ERROR updating location')
            _logger.error(f'   Error: {str(e)}')
            _logger.error(f'   Booking ID: {booking_id}')
            import traceback
            _logger.error(f'   Traceback: {traceback.format_exc()}')
            _logger.error('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ')
            return {'success': False, 'message': f'‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {str(e)}'}
    
    def _check_off_route(self, lat, lng, waypoints_json, max_distance):
        """
        ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        
        Parameters:
            - lat: Latitude ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            - lng: Longitude ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            - waypoints_json: JSON ‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
            - max_distance: ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï (‡πÄ‡∏°‡∏ï‡∏£)
        
        Returns:
            Boolean: True ‡∏ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
        """
        import json
        import math
        
        try:
            waypoints = json.loads(waypoints_json) if isinstance(waypoints_json, str) else waypoints_json
            if not waypoints:
                return False
            
            # ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 2 ‡∏à‡∏∏‡∏î (Haversine formula)
            def haversine_distance(lat1, lon1, lat2, lon2):
                R = 6371000  # ‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÇ‡∏•‡∏Å‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏°‡∏ï‡∏£
                
                lat1_rad = math.radians(lat1)
                lat2_rad = math.radians(lat2)
                delta_lat = math.radians(lat2 - lat1)
                delta_lon = math.radians(lon2 - lon1)
                
                a = math.sin(delta_lat/2)**2 + math.cos(lat1_rad) * math.cos(lat2_rad) * math.sin(delta_lon/2)**2
                c = 2 * math.atan2(math.sqrt(a), math.sqrt(1-a))
                
                return R * c
            
            # ‡∏´‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
            min_distance = float('inf')
            
            for waypoint in waypoints:
                if isinstance(waypoint, dict) and 'lat' in waypoint and 'lng' in waypoint:
                    distance = haversine_distance(lat, lng, waypoint['lat'], waypoint['lng'])
                    min_distance = min(min_distance, distance)
            
            # ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
            return min_distance > max_distance
            
        except Exception as e:
            _logger.error(f"‚ùå Error checking off route: {str(e)}")
            return False
    
    @http.route('/api/tracking/get_active_bookings', type='json', auth='user', methods=['POST'], csrf=False)
    def get_active_bookings(self, driver_id=None, **kwargs):
        """
        üöö API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
        
        Parameters:
            - driver_id: ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        """
        try:
            domain = [('state', 'in', ['confirmed', 'in_progress'])]
            if driver_id:
                domain.append(('driver_id', '=', int(driver_id)))
            
            bookings = request.env['vehicle.booking'].search(domain)
            
            results = []
            for booking in bookings:
                results.append({
                    'id': booking.id,
                    'name': booking.name,
                    'pickup_location': booking.pickup_location,
                    'destination': booking.destination,
                    'state': booking.state,
                    'tracking_status': booking.tracking_status,
                    'vehicle': {
                        'id': booking.vehicle_id.id,
                        'license_plate': booking.vehicle_id.license_plate,
                    } if booking.vehicle_id else None,
                    'driver': {
                        'id': booking.driver_id.id,
                        'name': booking.driver_id.name,
                    } if booking.driver_id else None,
                    'current_location': {
                        'latitude': booking.current_latitude,
                        'longitude': booking.current_longitude,
                        'last_update': booking.gps_last_update.isoformat() if booking.gps_last_update else None,
                    },
                    'planned_start_date': booking.planned_start_date.isoformat() if booking.planned_start_date else None,
                    'planned_end_date': booking.planned_end_date.isoformat() if booking.planned_end_date else None,
                })
            
            return {
                'success': True,
                'data': results,
                'count': len(results)
            }
        except Exception as e:
            _logger.error(f"‚ùå Error getting active bookings: {str(e)}")
            return {'success': False, 'message': str(e)}
    
    @http.route('/api/tracking/get_tracking_history', type='json', auth='user', methods=['POST'], csrf=False)
    def get_tracking_history(self, booking_id, limit=100, **kwargs):
        """
        üìä API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° GPS
        
        Parameters:
            - booking_id: ID ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ñ
            - limit: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (default: 100)
        """
        try:
            history = request.env['vehicle.tracking'].search([
                ('booking_id', '=', int(booking_id))
            ], limit=int(limit), order='timestamp desc')
            
            results = []
            for record in history:
                results.append({
                    'timestamp': record.timestamp.isoformat(),
                    'latitude': record.latitude,
                    'longitude': record.longitude,
                    'speed': record.speed,
                    'heading': record.heading,
                })
            
            return {
                'success': True,
                'data': results,
                'count': len(results)
            }
        except Exception as e:
            _logger.error(f"‚ùå Error getting tracking history: {str(e)}")
            return {'success': False, 'message': str(e)}
    
    @http.route('/api/settings/get', type='json', auth='user', methods=['POST'], csrf=False)
    def get_user_settings(self, **kwargs):
        """
        ‚öôÔ∏è API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        """
        try:
            settings = request.env['tracking.settings'].get_user_settings(request.env.user.id)
            
            return {
                'success': True,
                'data': settings
            }
        except Exception as e:
            _logger.error(f"‚ùå Error getting settings: {str(e)}")
            return {'success': False, 'message': str(e)}
    
    @http.route('/api/settings/update', type='json', auth='user', methods=['POST'], csrf=False)
    def update_user_settings(self, **kwargs):
        """
        ‚öôÔ∏è API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        
        Parameters:
            - tracking_enabled: Boolean
            - tracking_interval: Integer (seconds)
            - high_accuracy: Boolean
            - notify_on_arrival: Boolean
            - notify_on_delay: Boolean
            - notify_off_route: Boolean
            - off_route_distance: Integer (meters)
            - show_speed: Boolean
            - show_route: Boolean
            - map_type: String (roadmap/satellite/hybrid/terrain)
            - save_history: Boolean
            - history_retention_days: Integer
        """
        try:
            settings = request.env['tracking.settings'].search([
                ('user_id', '=', request.env.user.id)
            ], limit=1)
            
            if not settings:
                settings = request.env['tracking.settings'].create({
                    'user_id': request.env.user.id
                })
            
            vals = {}
            
            # ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
            if 'tracking_enabled' in kwargs:
                vals['tracking_enabled'] = bool(kwargs['tracking_enabled'])
            if 'tracking_interval' in kwargs:
                vals['tracking_interval'] = int(kwargs['tracking_interval'])
            if 'high_accuracy' in kwargs:
                vals['high_accuracy'] = bool(kwargs['high_accuracy'])
            
            # ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            if 'notify_on_arrival' in kwargs:
                vals['notify_on_arrival'] = bool(kwargs['notify_on_arrival'])
            if 'notify_on_delay' in kwargs:
                vals['notify_on_delay'] = bool(kwargs['notify_on_delay'])
            if 'notify_off_route' in kwargs:
                vals['notify_off_route'] = bool(kwargs['notify_off_route'])
            if 'off_route_distance' in kwargs:
                vals['off_route_distance'] = int(kwargs['off_route_distance'])
            
            # ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            if 'show_speed' in kwargs:
                vals['show_speed'] = bool(kwargs['show_speed'])
            if 'show_route' in kwargs:
                vals['show_route'] = bool(kwargs['show_route'])
            if 'map_type' in kwargs:
                vals['map_type'] = str(kwargs['map_type'])
            
            # ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            if 'save_history' in kwargs:
                vals['save_history'] = bool(kwargs['save_history'])
            if 'history_retention_days' in kwargs:
                vals['history_retention_days'] = int(kwargs['history_retention_days'])
            
            if vals:
                settings.write(vals)
            
            return {
                'success': True,
                'message': '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                'data': settings.get_user_settings(request.env.user.id)
            }
        except Exception as e:
            _logger.error(f"‚ùå Error updating settings: {str(e)}")
            return {'success': False, 'message': str(e)}
    
    @http.route('/api/tracking/update_status', type='json', auth='user', methods=['POST'], csrf=False)
    def update_tracking_status(self, booking_id, status, **kwargs):
        """
        üîÑ API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
        
        Parameters:
            - booking_id: ID ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ñ
            - status: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà (pending, picked_up, in_transit, near_destination, delivered)
        """
        try:
            booking = request.env['vehicle.booking'].browse(int(booking_id))
            if not booking.exists():
                return {'success': False, 'message': '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ñ'}
            
            vals = {'tracking_status': status}
            
            # ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            if status == 'picked_up':
                vals['actual_pickup_time'] = datetime.now()
            elif status == 'delivered':
                vals['actual_delivery_time'] = datetime.now()
            
            booking.write(vals)
            
            _logger.info(f"üîÑ Status updated for booking {booking.name}: {status}")
            
            return {
                'success': True,
                'message': '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                'data': {
                    'booking_id': booking.id,
                    'tracking_status': booking.tracking_status,
                }
            }
        except Exception as e:
            _logger.error(f"‚ùå Error updating status: {str(e)}")
            return {'success': False, 'message': str(e)}
