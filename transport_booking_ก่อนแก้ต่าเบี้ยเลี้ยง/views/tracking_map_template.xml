<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Template ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á -->
    <template id="tracking_map_template" name="Real-time Tracking Map">
        <html>
            <head>
                <meta charset="UTF-8"/>
                <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
                <title>üìç ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á - <t t-esc="booking.name"/></title>
                <style>
                    body {
                        margin: 0;
                        padding: 0;
                        font-family: Arial, sans-serif;
                    }
                    #map {
                        width: 100%;
                        height: calc(100vh - 120px);
                    }
                    .info-panel {
                        padding: 10px;
                        background: #f8f9fa;
                        border-bottom: 1px solid #dee2e6;
                    }
                    .info-item {
                        display: inline-block;
                        margin-right: 20px;
                        padding: 5px 10px;
                        background: white;
                        border-radius: 4px;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                    }
                    .info-label {
                        font-weight: bold;
                        color: #666;
                        font-size: 11px;
                    }
                    .info-value {
                        color: #333;
                        font-size: 13px;
                    }
                    .status-badge {
                        display: inline-block;
                        padding: 3px 8px;
                        border-radius: 3px;
                        font-size: 11px;
                        font-weight: bold;
                        color: white;
                    }
                    .status-pending { background: #6c757d; }
                    .status-in_transit { background: #0d6efd; }
                    .status-near_destination { background: #fd7e14; }
                    .status-delivered { background: #198754; }
                </style>
            </head>
            <body>
                <div class="info-panel">
                    <div class="info-item">
                        <div class="info-label">üìã ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á</div>
                        <div class="info-value"><t t-esc="booking.name"/></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">üöö ‡∏£‡∏ñ</div>
                        <div class="info-value"><t t-esc="booking.vehicle_id.license_plate if booking.vehicle_id else '-'"/></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">üë§ ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</div>
                        <div class="info-value"><t t-esc="booking.driver_id.name if booking.driver_id else '-'"/></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
                        <div class="info-value">
                            <span t-attf-class="status-badge status-{{ booking.tracking_status }}">
                                <t t-if="booking.tracking_status == 'pending'">‡∏£‡∏≠‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</t>
                                <t t-elif="booking.tracking_status == 'picked_up'">‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß</t>
                                <t t-elif="booking.tracking_status == 'in_transit'">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏ô‡∏™‡πà‡∏á</t>
                                <t t-elif="booking.tracking_status == 'near_destination'">‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</t>
                                <t t-elif="booking.tracking_status == 'delivered'">‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß</t>
                            </span>
                        </div>
                    </div>
                    <div class="info-item" id="lastUpdate">
                        <div class="info-label">üïê ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                        <div class="info-value">-</div>
                    </div>
                </div>
                
                <div id="map"></div>
                
                <script>
                    <![CDATA[
                    let map, vehicleMarker, pickupMarker, destinationMarker, routePolyline;
                    let bookingId = ]]><t t-esc="booking.id"/><![CDATA[;
                    let pickupLocation = ']]><t t-esc="booking.pickup_location or ''"/><![CDATA[';
                    let destination = ']]><t t-esc="booking.destination or ''"/><![CDATA[';
                    let pathCoordinates = [];
                    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á SVG icon ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏ñ
                    const truckSVG = `
                        <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="18" fill="#4285F4" stroke="white" stroke-width="3"/>
                            <text x="20" y="27" text-anchor="middle" font-size="20" fill="white">üöö</text>
                        </svg>
                    `;
                    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
                    function initMap() {
                        const defaultCenter = { lat: 14.8825, lng: 100.9925 };
                        
                        map = new google.maps.Map(document.getElementById('map'), {
                            zoom: 14,
                            center: defaultCenter,
                            mapTypeId: 'roadmap'
                        });
                        
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á marker ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏ñ (Vehicle Icon)
                        vehicleMarker = new google.maps.Marker({
                            map: map,
                            icon: {
                                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(truckSVG),
                                scaledSize: new google.maps.Size(40, 40),
                                anchor: new google.maps.Point(20, 20)
                            },
                            title: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏ñ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô',
                            zIndex: 999
                        });
                        
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á marker ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                        pickupMarker = new google.maps.Marker({
                            map: map,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: '#34A853',
                                fillOpacity: 1,
                                strokeColor: '#fff',
                                strokeWeight: 3,
                            },
                            title: '‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
                            label: {
                                text: 'A',
                                color: 'white',
                                fontWeight: 'bold'
                            }
                        });
                        
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á marker ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                        destinationMarker = new google.maps.Marker({
                            map: map,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: '#EA4335',
                                fillOpacity: 1,
                                strokeColor: '#fff',
                                strokeWeight: 3,
                            },
                            title: '‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á',
                            label: {
                                text: 'B',
                                color: 'white',
                                fontWeight: 'bold'
                            }
                        });
                        
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á polyline ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
                        routePolyline = new google.maps.Polyline({
                            map: map,
                            strokeColor: '#4285F4',
                            strokeOpacity: 0.8,
                            strokeWeight: 5,
                            path: [],
                            geodesic: true
                        });
                        
                        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        updateLocation();
                        
                        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≤‡∏° tracking_refresh_interval (‡∏ô‡∏≤‡∏ó‡∏µ -> ‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
                        // Default: 2 ‡∏ô‡∏≤‡∏ó‡∏µ = 120,000 ‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                        const refreshMinutes = 2; // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏´‡∏ô‡πà‡∏ß‡∏¢: ‡∏ô‡∏≤‡∏ó‡∏µ)
                        const refreshInterval = refreshMinutes * 60 * 1000; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                        setInterval(updateLocation, refreshInterval);
                    }
                    
                    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                    function updateLocation() {
                        fetch('/web/dataset/call_kw', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                jsonrpc: '2.0',
                                method: 'call',
                                params: {
                                    model: 'vehicle.booking',
                                    method: 'read',
                                    args: [[bookingId], [
                                        'current_latitude', 
                                        'current_longitude', 
                                        'gps_last_update', 
                                        'tracking_status',
                                        'pickup_latitude',
                                        'pickup_longitude',
                                        'destination_latitude',
                                        'destination_longitude'
                                    ]],
                                    kwargs: {}
                                },
                                id: Math.floor(Math.random() * 1000000)
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.result && data.result.length > 0) {
                                const booking = data.result[0];
                                
                                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏ñ
                                const lat = parseFloat(booking.current_latitude);
                                const lng = parseFloat(booking.current_longitude);
                                
                                if (!isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0) {
                                    const position = new google.maps.LatLng(lat, lng);
                                    
                                    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó vehicle marker
                                    vehicleMarker.setPosition(position);
                                    vehicleMarker.setVisible(true);
                                    
                                    // ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á
                                    map.setCenter(position);
                                    
                                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÉ‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
                                    pathCoordinates.push(position);
                                    routePolyline.setPath(pathCoordinates);
                                    
                                    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏ß‡∏•‡∏≤
                                    if (booking.gps_last_update) {
                                        try {
                                            const updateTime = new Date(booking.gps_last_update);
                                            document.querySelector('#lastUpdate .info-value').textContent = 
                                                updateTime.toLocaleString('th-TH');
                                        } catch (e) {
                                            console.error('Error parsing date:', e);
                                        }
                                    }
                                } else {
                                    vehicleMarker.setVisible(false);
                                }
                                
                                // ‡πÅ‡∏™‡∏î‡∏á pickup marker
                                if (booking.pickup_latitude && booking.pickup_longitude) {
                                    const pickupLat = parseFloat(booking.pickup_latitude);
                                    const pickupLng = parseFloat(booking.pickup_longitude);
                                    if (!isNaN(pickupLat) && !isNaN(pickupLng) && pickupLat !== 0 && pickupLng !== 0) {
                                        const pickupPos = new google.maps.LatLng(pickupLat, pickupLng);
                                        pickupMarker.setPosition(pickupPos);
                                        pickupMarker.setVisible(true);
                                    }
                                } else {
                                    pickupMarker.setVisible(false);
                                }
                                
                                // ‡πÅ‡∏™‡∏î‡∏á destination marker
                                if (booking.destination_latitude && booking.destination_longitude) {
                                    const destLat = parseFloat(booking.destination_latitude);
                                    const destLng = parseFloat(booking.destination_longitude);
                                    if (!isNaN(destLat) && !isNaN(destLng) && destLat !== 0 && destLng !== 0) {
                                        const destPos = new google.maps.LatLng(destLat, destLng);
                                        destinationMarker.setPosition(destPos);
                                        destinationMarker.setVisible(true);
                                    }
                                } else {
                                    destinationMarker.setVisible(false);
                                }
                                
                                // ‡∏õ‡∏£‡∏±‡∏ö zoom ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î
                                if (pickupMarker.getVisible() || destinationMarker.getVisible() || vehicleMarker.getVisible()) {
                                    const bounds = new google.maps.LatLngBounds();
                                    if (pickupMarker.getVisible()) bounds.extend(pickupMarker.getPosition());
                                    if (destinationMarker.getVisible()) bounds.extend(destinationMarker.getPosition());
                                    if (vehicleMarker.getVisible()) bounds.extend(vehicleMarker.getPosition());
                                    map.fitBounds(bounds);
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching location:', error);
                        });
                    }
                    ]]>
                </script>
                
                <!-- Load Google Maps API with key from database -->
                <t t-set="maps_url" t-value="'https://maps.googleapis.com/maps/api/js?key=' + str(api_key) + '&amp;callback=initMap&amp;v=weekly'"/>
                <script t-att-src="maps_url" async="async" defer="defer"></script>
            </body>
        </html>
    </template>
    
    <!-- Template ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á Error -->
    <template id="tracking_map_error" name="Tracking Map Error">
        <html>
            <head>
                <title>Error</title>
                <style>
                    body {
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        height: 100vh;
                        margin: 0;
                        font-family: Arial, sans-serif;
                        background: #f8f9fa;
                    }
                    .error-box {
                        text-align: center;
                        padding: 40px;
                        background: white;
                        border-radius: 8px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    }
                    .error-icon {
                        font-size: 48px;
                        color: #dc3545;
                    }
                    .error-message {
                        margin-top: 20px;
                        color: #666;
                    }
                </style>
            </head>
            <body>
                <div class="error-box">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <h2>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h2>
                    <p class="error-message"><t t-esc="error_message"/></p>
                </div>
            </body>
        </html>
    </template>
</odoo>
