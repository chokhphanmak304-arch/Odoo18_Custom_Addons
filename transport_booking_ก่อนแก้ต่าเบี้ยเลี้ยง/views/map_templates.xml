<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Map View Template -->
        <template id="map_view" name="Booking Map View">
            <html>
                <head>
                    <meta charset="utf-8"/>
                    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
                    <title>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á - <t t-esc="booking.name"/></title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            padding: 20px;
                        }
                        .container {
                            max-width: 1400px;
                            margin: 0 auto;
                            background: white;
                            border-radius: 15px;
                            overflow: hidden;
                            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                        }
                        .header {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 30px;
                            text-align: center;
                        }
                        .header h1 { font-size: 28px; margin-bottom: 10px; }
                        .header p { font-size: 16px; opacity: 0.9; }
                        #map { width: 100%; height: 70vh; min-height: 500px; }
                        .info-panel {
                            padding: 30px;
                            background: #f8f9fa;
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                            gap: 20px;
                        }
                        .info-card {
                            background: white;
                            padding: 20px;
                            border-radius: 10px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        }
                        .info-label {
                            font-size: 14px;
                            color: #6c757d;
                            margin-bottom: 8px;
                            font-weight: 500;
                        }
                        .info-value { font-size: 16px; color: #333; font-weight: bold; }
                        .info-value.origin { color: #28a745; }
                        .info-value.destination { color: #dc3545; }
                        .info-value.distance { color: #4285F4; font-size: 24px; }
                        #route-info {
                            margin-top: 15px;
                            padding-top: 15px;
                            border-top: 2px solid #e9ecef;
                        }
                        .loading {
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background: white;
                            padding: 30px;
                            border-radius: 10px;
                            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                            text-align: center;
                            z-index: 1000;
                        }
                        .spinner {
                            border: 4px solid #f3f3f3;
                            border-top: 4px solid #667eea;
                            border-radius: 50%;
                            width: 50px;
                            height: 50px;
                            animation: spin 1s linear infinite;
                            margin: 0 auto 15px;
                        }
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</h1>
                            <p><t t-esc="booking.name"/> - <t t-esc="booking.partner_id.name"/></p>
                        </div>

                        <div style="position: relative;">
                            <div id="loading" class="loading">
                                <div class="spinner"></div>
                                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...</p>
                            </div>
                            <div id="map"></div>
                        </div>

                        <div class="info-panel">
                            <div class="info-card">
                                <div class="info-label">üìç ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>
                                <div class="info-value origin"><t t-esc="origin"/></div>
                            </div>
                            <div class="info-card">
                                <div class="info-label">üéØ ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</div>
                                <div class="info-value destination"><t t-esc="destination"/></div>
                            </div>
                            <div class="info-card">
                                <div class="info-label">üìè ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</div>
                                <div class="info-value distance" id="distance-text">
                                    <t t-esc="'%.2f' % booking.distance_km"/> ‡∏Å‡∏°.
                                </div>
                                <div id="route-info"></div>
                            </div>
                        </div>
                    </div>

                    <script>
                        var GOOGLE_API_KEY = '<t t-esc="api_key"/>';
                        var originData = '<t t-esc="origin"/>';
                        var destinationData = '<t t-esc="destination"/>';
                    </script>
                    <script>
                        (function() {
                            var script = document.createElement('script');
                            script.src = 'https://maps.googleapis.com/maps/api/js?key=' + GOOGLE_API_KEY + '&amp;libraries=geometry,places&amp;language=th&amp;callback=initMap';
                            script.async = true;
                            document.head.appendChild(script);
                        })();
                    </script>
                    <script><![CDATA[
                        let map, directionsService, directionsRenderer;

                        function initMap() {
                            map = new google.maps.Map(document.getElementById('map'), {
                                zoom: 12,
                                center: { lat: 13.7563, lng: 100.5018 },
                                mapTypeControl: true,
                                streetViewControl: true,
                                fullscreenControl: true,
                                zoomControl: true
                            });

                            directionsService = new google.maps.DirectionsService();
                            directionsRenderer = new google.maps.DirectionsRenderer({
                                map: map,
                                suppressMarkers: false,
                                polylineOptions: {
                                    strokeColor: '#4285F4',
                                    strokeWeight: 5,
                                    strokeOpacity: 0.8
                                }
                            });

                            calculateRoute();
                        }

                        function calculateRoute() {
                            const request = {
                                origin: originData,
                                destination: destinationData,
                                travelMode: google.maps.TravelMode.DRIVING,
                                region: 'TH'
                            };

                            console.log('üìç Starting route calculation with origin:', originData, 'destination:', destinationData);

                            directionsService.route(request, function(result, status) {
                                console.log('üìä Route Response - Status:', status, 'Result:', result);
                                document.getElementById('loading').style.display = 'none';

                                // ‚úÖ Proper null/undefined checks
                                if (status === 'OK' && result && result.routes && result.routes.length > 0) {
                                    console.log('‚úÖ Route calculation successful');
                                    directionsRenderer.setDirections(result);

                                    const route = result.routes[0];
                                    if (route.legs && route.legs.length > 0) {
                                        const leg = route.legs[0];
                                        const distanceKm = (leg.distance.value / 1000).toFixed(2);
                                        const duration = leg.duration.text;

                                        console.log('üìè Distance:', distanceKm, 'km, Duration:', duration);

                                        document.getElementById('distance-text').innerHTML = distanceKm + ' ‡∏Å‡∏°.';

                                        document.getElementById('route-info').innerHTML =
                                            '<div style="font-size: 14px; color: #6c757d; margin-top: 5px;">' +
                                            '‚è±Ô∏è ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: <strong>' + duration + '</strong>' +
                                            '</div>';
                                    }
                                } else {
                                    console.error('‚ùå Route Error - Status:', status, 'Result:', result);
                                    let errorMsg = status;
                                    if (status === 'ZERO_RESULTS') {
                                        errorMsg = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á ‡∏•‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà';
                                    } else if (status === 'OVER_QUERY_LIMIT') {
                                        errorMsg = '‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô API';
                                    } else if (status === 'REQUEST_DENIED') {
                                        errorMsg = 'API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                                    }
                                    document.getElementById('loading').innerHTML =
                                        '<p style="color: #dc3545;">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ<br>' +
                                        '<small>' + errorMsg + '</small></p>';
                                }
                            });
                        }
                    ]]></script>
                </body>
            </html>
        </template>

        <!-- Error Template -->
        <template id="map_error" name="Map Error">
            <html>
                <head>
                    <meta charset="utf-8"/>
                    <title>Error</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            height: 100vh;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            margin: 0;
                        }
                        .error-box {
                            background: white;
                            padding: 50px;
                            border-radius: 15px;
                            text-align: center;
                            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                        }
                        .error-box h1 {
                            color: #dc3545;
                            font-size: 48px;
                            margin-bottom: 20px;
                        }
                        .error-box p {
                            color: #6c757d;
                            font-size: 18px;
                        }
                    </style>
                </head>
                <body>
                    <div class="error-box">
                        <h1>‚ö†Ô∏è</h1>
                        <p><t t-esc="error"/></p>
                    </div>
                </body>
            </html>
        </template>
    </data>
</odoo>
