#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
üîß Fix Daily Allowance Display in Delivery History
‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á

‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥:
1. ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï View XML
2. ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä Odoo
3. ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä View
4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
"""

import os
import sys
import time
import subprocess
import logging
from pathlib import Path

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# ‡∏û‡∏≤‡∏ò
ODOO_PATH = r"C:\Program Files\Odoo 18.0.20251009\server"
ADDON_PATH = os.path.join(ODOO_PATH, "custom-addons", "transport_booking")
VIEWS_PATH = os.path.join(ADDON_PATH, "views")
XML_FILE = os.path.join(VIEWS_PATH, "delivery_history_views.xml")

def restart_odoo():
    """‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó Odoo Service"""
    logger.info("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó Odoo Service...")
    try:
        # ‡∏´‡∏¢‡∏∏‡∏î Service
        subprocess.run(["net", "stop", "odoo"], 
                      capture_output=True, text=True, check=False)
        time.sleep(3)
        
        # ‡πÄ‡∏£‡∏¥‡πà‡∏° Service
        result = subprocess.run(["net", "start", "odoo"],
                              capture_output=True, text=True)
        
        if "service was started successfully" in result.stdout or result.returncode == 0:
            logger.info("‚úÖ Odoo Service ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")
            time.sleep(5)
            return True
        else:
            logger.warning("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó Service ‡∏ú‡πà‡∏≤‡∏ô net ‡∏´‡∏£‡∏∑‡∏≠ Admin ‡πÅ‡∏•‡πâ‡∏ß")
            return False
    except Exception as e:
        logger.error(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {str(e)}")
        return False

def clear_odoo_cache():
    """‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä Odoo"""
    logger.info("üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä Odoo...")
    cache_paths = [
        os.path.join(ODOO_PATH, "custom-addons", "transport_booking", "__pycache__"),
        os.path.join(ODOO_PATH, "custom-addons", "transport_booking", "models", "__pycache__"),
        os.path.join(ODOO_PATH, "custom-addons", "transport_booking", "controllers", "__pycache__"),
    ]
    
    for path in cache_paths:
        if os.path.exists(path):
            try:
                import shutil
                shutil.rmtree(path)
                logger.info(f"‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä: {path}")
            except Exception as e:
                logger.warning(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä {path}: {str(e)}")

def verify_xml_changes():
    """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ XML ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß"""
    logger.info("üìã ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç XML...")
    try:
        with open(XML_FILE, 'r', encoding='utf-8') as f:
            content = f.read()
            if 'width=' in content and 'daily_allowance' in content:
                logger.info("‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô XML")
                # ‡∏´‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ daily_allowance
                lines = content.split('\n')
                for i, line in enumerate(lines):
                    if 'daily_allowance' in line:
                        logger.info(f"   ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î {i+1}: {line.strip()}")
                return True
            else:
                logger.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÉ‡∏ô XML")
                return False
    except Exception as e:
        logger.error(f"‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô XML: {str(e)}")
        return False

def run_odoo_shell_command(command):
    """‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Odoo ‡∏ú‡πà‡∏≤‡∏ô Shell"""
    logger.info(f"üìù ‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: {command}")
    try:
        script = f"""
import os
os.chdir(r'{ODOO_PATH}')

import odoo
from odoo.cli.main import main as cli_main

# ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå
sys.argv = ['odoo', '-c', r'{os.path.join(ODOO_PATH, "odoo.conf")}']

# ‡∏£‡∏±‡∏ô Odoo ‡∏ó‡∏µ‡πà‡∏°‡∏µ shell
cli_main(['--shell-like', '--update=transport_booking'])
"""
        
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå shell script ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
        shell_file = os.path.join(ADDON_PATH, "temp_shell_fix.py")
        with open(shell_file, 'w', encoding='utf-8') as f:
            f.write(script)
        
        logger.info(f"‚ö†Ô∏è ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Odoo Shell (‡∏ï‡πâ‡∏≠‡∏á Admin)")
        logger.info(f"üìå ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏±‡∏ô: python {shell_file}")
        
        return True
    except Exception as e:
        logger.error(f"‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {str(e)}")
        return False

def main():
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å"""
    print("""
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë  üîß ‡∏ï‡∏±‡∏ß‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á - Delivery History      ‚ïë
    ‚ïë     Daily Allowance Display Fix                               ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    """)
    
    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö XML
    logger.info("\nüìç ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå XML")
    if not verify_xml_changes():
        logger.error("‚ùå XML ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç")
        sys.exit(1)
    
    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä
    logger.info("\nüìç ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä")
    clear_odoo_cache()
    
    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó Odoo
    logger.info("\nüìç ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó Odoo")
    if restart_odoo():
        logger.info("‚úÖ Odoo ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")
    else:
        logger.warning("‚ö†Ô∏è ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á")
    
    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    logger.info("\n" + "="*70)
    logger.info("üìå ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:")
    logger.info("   1. ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö Odoo")
    logger.info("   2. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Transport Booking > ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á")
    logger.info("   3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á' ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß")
    logger.info("   4. ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (F5)")
    logger.info("="*70)
    
    print("\n‚úÖ ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!")

if __name__ == '__main__':
    main()
